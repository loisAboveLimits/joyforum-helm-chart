name: Publish Helm chart to ACR

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  # Azure Container Registry login server
  ACR_LOGIN_SERVER: acrselabyoruat.azurecr.io

  HELM_CHART_DIR: .
  
  HELM_REPOSITORY_PATH: helm/joyform

jobs:
  helm-package-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.15.0

      - name: Show Helm version
        run: helm version

      - name: Lint chart
        run: helm lint "$HELM_CHART_DIR"

      - name: Update chart dependencies
        run: |
          if [ -f "$HELM_CHART_DIR/Chart.yaml" ]; then
            helm dependency update "$HELM_CHART_DIR"
          fi

      - name: Package chart
        id: package
        run: |
          mkdir -p packages
          OUTPUT=$(helm package "$HELM_CHART_DIR" --destination ./packages)
          echo "$OUTPUT"
          FILE_PATH=$(echo "$OUTPUT" | awk '{print $NF}')
          echo "file_path=$FILE_PATH" >> "$GITHUB_OUTPUT"

      - name: Login to ACR as Helm registry
        env:
          ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
        run: |
          echo "$ACR_PASSWORD" | helm registry login "$ACR_LOGIN_SERVER" \
            --username "$ACR_USERNAME" \
            --password-stdin

      - name: Push chart to ACR
        run: |
          FILE_PATH="${{ steps.package.outputs.file_path }}"
          echo "Pushing chart $FILE_PATH to oci://$ACR_LOGIN_SERVER/$HELM_REPOSITORY_PATH"
          helm push "$FILE_PATH" "oci://$ACR_LOGIN_SERVER/$HELM_REPOSITORY_PATH"
