name: Publish Helm Chart to ACR (UAT)

on:
  push:
    branches:
      - UAT
  workflow_dispatch:

env:
  ACR_LOGIN_SERVER: acrselabyoruat.azurecr.io
  HELM_CHART_DIR: .
  HELM_REPOSITORY_PATH: helm/joyform

jobs:
  helm-package-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.15.0

      - name: Show Helm version
        run: helm version

      - name: Prepare UAT values.yaml
        run: |
          echo "Preparing UAT values"
          rm -f values-prod.yaml
          mv values-uat.yaml values.yaml

      - name: Update chart dependencies
        run: |
          if [ -f "$HELM_CHART_DIR/Chart.yaml" ]; then
            helm dependency update "$HELM_CHART_DIR"
          fi

      - name: Package chart
        id: package
        run: |
          mkdir -p packages
          OUTPUT=$(helm package "$HELM_CHART_DIR" --destination ./packages)
          FILE_PATH=$(echo "$OUTPUT" | awk '{print $NF}')
          echo "file_path=$FILE_PATH" >> "$GITHUB_OUTPUT"

      - name: Login to ACR as Helm registry
        env:
          ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
        run: |
          echo "$ACR_PASSWORD" | helm registry login "$ACR_LOGIN_SERVER" \
            --username "$ACR_USERNAME" \
            --password-stdin

      - name: Push chart to ACR
        run: |
          helm push "${{ steps.package.outputs.file_path }}" \
            "oci://$ACR_LOGIN_SERVER/$HELM_REPOSITORY_PATH"














# name: Publish Helm chart to ACR

# on:
#   push:
#     branches:
#       - UAT
#   workflow_dispatch:

# env:
#   ACR_LOGIN_SERVER: acrselabyoruat.azurecr.io
#   HELM_CHART_DIR: .

# jobs:
#   helm-package-and-push:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Install Helm
#         uses: azure/setup-helm@v4
#         with:
#           version: v3.15.0

#       - name: Show Helm version
#         run: helm version

#       - name: Set environment-specific variables
#         run: |
#           if [[ "${GITHUB_REF_NAME}" == "UAT" ]]; then
#             echo "HELM_REPOSITORY_PATH=helm/joyform" >> $GITHUB_ENV
#             echo "VALUES_FILE=values-uat.yaml" >> $GITHUB_ENV
#           elif [[ "${GITHUB_REF_NAME}" == "main" ]]; then
#             echo "HELM_REPOSITORY_PATH=helm/joyform-prod" >> $GITHUB_ENV
#             echo "VALUES_FILE=values-prod.yaml" >> $GITHUB_ENV
#           fi

#       - name: Update chart dependencies
#         run: |
#           if [ -f "$HELM_CHART_DIR/Chart.yaml" ]; then
#             helm dependency update "$HELM_CHART_DIR"
#           fi

#       - name: Package chart
#         id: package
#         run: |
#           mkdir -p packages
#           OUTPUT=$(helm package "$HELM_CHART_DIR" --destination ./packages)
#           echo "$OUTPUT"
#           FILE_PATH=$(echo "$OUTPUT" | awk '{print $NF}')
#           echo "file_path=$FILE_PATH" >> "$GITHUB_OUTPUT"

#       - name: Login to ACR as Helm registry
#         env:
#           ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
#           ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
#         run: |
#           echo "$ACR_PASSWORD" | helm registry login "$ACR_LOGIN_SERVER" \
#             --username "$ACR_USERNAME" \
#             --password-stdin

#       - name: Push chart to ACR
#         run: |
#           FILE_PATH="${{ steps.package.outputs.file_path }}"
#           echo "Pushing chart $FILE_PATH to oci://$ACR_LOGIN_SERVER/$HELM_REPOSITORY_PATH"
#           helm push "$FILE_PATH" "oci://$ACR_LOGIN_SERVER/$HELM_REPOSITORY_PATH"
