replicaCount: 2

# Autoscaling configuration
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilizationPercentage: 80

# Shared storage for wp-content
persistence:
  enabled: false
  size: 5Gi
  storageClass: azurefile-csi
  accessMode: ReadWriteMany
  mountPath: /var/www/html/wp-content/uploads

# Security Context to help with Azure File permissions
podSecurityContext:
  fsGroup: 33  # GID for www-data

image:
  repository: acrselabyor.azurecr.io/joyforum-wp-prod
  tag: eb4f7b64730f659631b652cf3922fc67ba8c32b2
  pullPolicy: IfNotPresent

service:
  type: LoadBalancer
  port: 80
  annotations:
    service.beta.kubernetes.io/azure-load-balancer-internal: "true"

resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 512Mi

deployment:
  revisionHistoryLimit: 5
  strategy:
    type: RollingUpdate

serviceAccount:
  create: false
  name: vendor-access-sa
  automount: true
  annotations:
    azure.workload.identity/client-id: "a2a29a24-5fe5-450a-8791-588ba52dc30f"

externalSecrets:
  enabled: true
  secretStore:
    name: wordpress-azure-kv-store
    azureKeyVaultName: kv-csi-joy-forum-o8o9s
    tenantId: "606bd698-03f5-4b63-9ba3-1272b3fd2c3c"
    # RESTORED: This line is required by your template to avoid the "null" error
    serviceAccountName: vendor-access-sa
  secrets:
    - name: wordpress-db-secret
      data:
        - secretKey: WORDPRESS_DB_USER
          remoteRefKey: MySQLAdminUsername
        - secretKey: WORDPRESS_DB_PASSWORD
          remoteRefKey: MySQLAdminPassword
        - secretKey: WORDPRESS_DB_HOST
          remoteRefKey: MySQLHost
        - secretKey: WORDPRESS_DB_NAME
          remoteRefKey: MySQLDatabaseName

wordpress:
  configExtra: |
    if (isset($_SERVER['HTTP_X_FORWARDED_HOST'])) {
        $_SERVER['HTTP_HOST'] = $_SERVER['HTTP_X_FORWARDED_HOST'];
    }
    if (isset($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https') {
        $_SERVER['HTTPS'] = 'on';
    }
    define('MYSQL_CLIENT_FLAGS', MYSQLI_CLIENT_SSL);
    define('WP_HOME', 'https://joyforum-prd.singlet.cloud');
    define('WP_SITEURL', 'https://https://joyforum-prd.singlet.cloud');

# ---- Added annotation to prevent LoadBalancer recreation on reinstall ----
service:
  type: LoadBalancer
  port: 80
  annotations:
    service.beta.kubernetes.io/azure-load-balancer-internal: "true"
    # Added this annotation to preserve the same internal load balancer on reinstall

# ---- Explicitly define PersistentVolumeClaim retention ----
persistence:
  enabled: false
  size: 5Gi
  storageClass: azurefile-csi
  accessMode: ReadWriteMany
  mountPath: /var/www/html/wp-content/uploads
  # Important: To keep data persistent across reinstalls, make sure PVCs are not deleted automatically.
  # This depends on your PVC reclaim policy in your cluster, which should be 'Retain'

ingress:
  enabled: false
  className: azure-application-gateway
  hosts:
    - host: https://joyforum-prd.singlet.cloud
      paths:
        - path: /
          pathType: Prefix
